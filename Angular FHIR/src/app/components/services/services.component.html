<div *ngIf="showPopup" class="popup-notification" [ngClass]="{'popup-success': popupType === 'success', 'popup-error': popupType === 'error'}">
  <div class="popup-content">
    <i [ngClass]="{'bi bi-check-circle-fill': popupType === 'success', 'bi bi-x-circle-fill': popupType === 'error'}"></i>
    <p>{{ popupMessage }}</p>
  </div>
</div>
<div class="page-container">
  <!-- Panneau lat√©ral gauche -->
  <div class="side-panel left-panel">
    <div class="slide-container">
      <!-- Utilisez *ngFor pour cr√©er les slides de mani√®re dynamique -->
      <div *ngFor="let slide of slides" class="slide" [class.active]="slide.active">
        <img [src]="slide.imageUrl" [alt]="slide.title">
        <div class="info-overlay">
          <h3>{{ slide.title }}</h3>
          <p>{{ slide.description }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenu principal (formulaire) -->
  <div class="main-content">
    <h2>Cr√©er une Unit√© Fonctionnelle</h2>
    
<!-- <div *ngIf="formStatus()" class="alert" [ngClass]="{'alert-success': formStatus().includes('succ√®s'), 'alert-danger': formStatus().includes('erreur') || formStatus().includes('Erreur')}">
  {{ formStatus() }}
</div> -->
    
    <form [formGroup]="myForm" (ngSubmit)="onSubmit()" class="form">
      <div class="progress-bar">
        <div class="progress" [style.width]="(currentSlide + 1) * (100 / totalSlides) + '%'"></div>
      </div>
      <div class="step-indicator">
        √âtape {{ currentSlide + 1 }} sur {{ totalSlides }}
      </div>
      
      <swiper-container #swiper allowTouchMove="false">
        <!-- Page 1: Informations g√©n√©rales -->
        <swiper-slide>
          <div class="slide-content">
            <h3>Informations g√©n√©rales</h3>
            
            <!-- Nom de l'unit√© fonctionnelle -->
            <div class="form-group">
              <label for="name">Nom de l'unit√© fonctionnelle</label>
              <input 
                type="text" 
                id="name" 
                formControlName="name"
                placeholder="Ex: Service de Cardiologie"
              >
              <div *ngIf="isFieldInvalid('name')" class="error-message">
                {{ getErrorMessage('name') }}
              </div>
            </div>
           
  <!-- UF Num√©rique unique -->
            <div class="form-group">
              <label for="ufNumero">Num√©ro UF (unique)</label>
              <input 
                type="text" 
                id="ufNumero" 
                formControlName="ufNumero"
                placeholder="Ex: 1234"
              >
              <small class="form-text text-muted">Doit √™tre compos√© de 4 √† 6 chiffres et doit √™tre unique.</small>
              <div *ngIf="isFieldInvalid('ufNumero')" class="error-message">
                {{ getErrorMessage('ufNumero') }}
              </div>
              </div>
            
            
            <!-- Description -->
            <div class="form-group">
              <label for="description">Description</label>
              <textarea
                id="description"
                formControlName="description"
                placeholder="Description de l'unit√© fonctionnelle"
                rows="2"
              ></textarea>
            </div>
            
            <!-- Statut -->
            <div class="form-group">
              <label for="status">Statut</label>
              <select 
                id="status" 
                formControlName="status" 
              >
                <option value="active">Actif</option>
                <option value="suspended">Suspendu</option>
                <option value="inactive">Inactif</option>
              </select>
              <div *ngIf="isFieldInvalid('status')" class="error-message">
                {{ getErrorMessage('status') }}
              </div>
            </div>
            
            <!-- √âtablissement parent -->
            <div class="form-group">
              <label for="etablissementId">√âtablissement parent</label>
              <div class="etablissement-selection">
                <select 
                  id="etablissementId" 
                  formControlName="etablissementId" 
                  [disabled]="isLoading"
                >
                  <option value="" disabled selected>S√©lectionnez un √©tablissement</option>
                  <option *ngFor="let etab of etablissements" [value]="etab.id">
                    {{ etab.name }}
                  </option>
                </select>
                
                <button type="button" class="btn btn-secondary" (click)="toggleAddEtablissementForm()">
                  {{ showAddEtablissementForm ? 'Annuler' : 'Nouvel √©tablissement' }}
                </button>
              </div>
              <div *ngIf="isLoading" class="loading-message">
                Chargement des √©tablissements...
              </div>
              <div *ngIf="loadingError" class="error-message">
                Erreur lors du chargement des √©tablissements. 
                <button type="button" class="btn btn-link" (click)="loadEtablissements()">
                  R√©essayer
                </button>
              </div>
              <div *ngIf="isFieldInvalid('etablissementId')" class="error-message">
                {{ getErrorMessage('etablissementId') }}
              </div>
            </div>
            
            <!-- Formulaire pour ajouter un nouvel √©tablissement -->
            <div *ngIf="showAddEtablissementForm" class="add-etablissement-form">
              <h4>Ajouter un nouvel √©tablissement</h4>
              <form [formGroup]="etablissementForm" (ngSubmit)="onAddEtablissement()" class="etablissement-form">
                <div class="form-group">
                  <label for="etabName">Nom de l'√©tablissement</label>
                  <input type="text" id="etabName" formControlName="name" required>
                  <div *ngIf="isFieldInvalid('name', etablissementForm)" class="error-message">
                    {{ getErrorMessage('name', etablissementForm) }}
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="etabAddressLine">Adresse</label>
                  <input type="text" id="etabAddressLine" formControlName="addressLine">
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="etabCity">Ville</label>
                    <input type="text" id="etabCity" formControlName="city" required>
                    <div *ngIf="isFieldInvalid('city', etablissementForm)" class="error-message">
                      {{ getErrorMessage('city', etablissementForm) }}
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label for="etabPostalCode">Code postal</label>
                    <input type="text" id="etabPostalCode" formControlName="postalCode" required>
                    <div *ngIf="isFieldInvalid('postalCode', etablissementForm)" class="error-message">
                      {{ getErrorMessage('postalCode', etablissementForm) }}
                    </div>
                  </div>
                </div>
                
                <div class="form-buttons">
                  <button type="button" class="btn btn-secondary" (click)="toggleAddEtablissementForm()">
                    Annuler
                  </button>
                  <button type="submit" class="btn btn-primary" [disabled]="etablissementForm.invalid">
                    Cr√©er l'√©tablissement
                  </button>
                </div>
              </form>
            </div>
          </div>
        </swiper-slide>
        
        <!-- Page 2: Informations de localisation dans l'√©tablissement -->
        <swiper-slide>
          <div class="slide-content">
            <h3>Localisation dans l'√©tablissement</h3>
            
            <!-- √âtage -->
            <div class="form-group">
              <label for="floor">√âtage</label>
              <input
                type="text"
                id="floor"
                formControlName="floor"
                placeholder="Ex: 2, Rez-de-chauss√©e, etc."
              >
            </div>
            
            <!-- Aile/B√¢timent -->
            <div class="form-group">
              <label for="wing">Aile/B√¢timent</label>
              <input
                type="text"
                id="wing"
                formControlName="wing"
                placeholder="Ex: Aile Est, Pavillon B, etc."
              >
            </div>
            
            <!-- Num√©ro de salle -->
            <div class="form-group">
              <label for="roomNumber">Num√©ro de salle</label>
              <input
                type="text"
                id="roomNumber"
                formControlName="roomNumber"
                placeholder="Ex: 204, A12, etc."
              >
            </div>
            
            <!-- Adresse - Utilisation -->
            <div class="form-group">
              <label for="addressUse">Type d'adresse</label>
              <select 
                id="addressUse" 
                formControlName="addressUse" 
              >
                <option value="work">Travail</option>
                <option value="temp">Temporaire</option>
                <option value="old">Ancienne</option>
              </select>
              <div *ngIf="isFieldInvalid('addressUse')" class="error-message">
                {{ getErrorMessage('addressUse') }}
              </div>
            </div>
            
          
          </div>
        </swiper-slide>
        

        
        <!-- Page 4: R√©capitulatif et soumission -->
        <swiper-slide>
          <div class="slide-content summary">
            <h3>R√©capitulatif</h3>
            
            <div class="summary-section">
              <h4>Informations g√©n√©rales</h4>
              <div class="summary-item">
                <span class="label">Nom de l'UF:</span> 
                <span class="value">{{ myForm.get('name')?.value }}</span>
              </div>
               <div class="summary-item">
                <span class="label">ZADIG</span> 
                <span class="value">{{ myForm.get('ufNumero')?.value }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Description:</span> 
                <span class="value">{{ myForm.get('description')?.value || 'Non sp√©cifi√©e' }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Statut:</span> 
                <span class="value">{{ getStatusLabel(myForm.get('status')?.value) }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Type:</span> 
                <span class="value">{{ getTypeLabel(myForm.get('typeCode')?.value) }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">√âtablissement parent:</span> 
                <span class="value">{{ getEtablissementName(myForm.get('etablissementId')?.value) }}</span>
              </div>
            </div>
            
            <div class="summary-section">
              <h4>Localisation dans l'√©tablissement</h4>
              <div class="summary-item">
                <span class="label">√âtage:</span> 
                <span class="value">{{ myForm.get('floor')?.value || 'Non sp√©cifi√©' }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Aile/B√¢timent:</span> 
                <span class="value">{{ myForm.get('wing')?.value || 'Non sp√©cifi√©' }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Num√©ro de salle:</span> 
                <span class="value">{{ myForm.get('roomNumber')?.value || 'Non sp√©cifi√©' }}</span>
              </div>
            </div>
            
        
          </div>
        </swiper-slide>
      </swiper-container>
      
      <div class="form-navigation">
        <!-- Bouton Pr√©c√©dent uniquement si currentSlide > 0 -->
        <button *ngIf="currentSlide > 0" type="button" class="btn btn-primary" (click)="previousSlide()">
          Pr√©c√©dent
        </button>
        <div *ngIf="currentSlide === 0"></div>
        
        <button *ngIf="currentSlide < totalSlides - 1" type="button" class="btn btn-primary" (click)="nextSlide()">
          Suivant
        </button>
        
        <button *ngIf="currentSlide === totalSlides - 1" type="submit" class="btn btn-success" [disabled]="!myForm.valid">
          Cr√©er l'unit√© fonctionnelle
        </button>
      </div>
    </form>
  </div>
<!-- Panneau lat√©ral droit : Liste des √©tablissements et UF -->
<div class="side-panel right-panel">
  <div class="panel-header">
    <h2>√âtablissements et Unit√©s Fonctionnelles</h2>
    <div class="search-container">
      <input type="text" placeholder="Rechercher..." [(ngModel)]="searchTerm" (input)="filterList()">
      <i class="bi bi-search search-icon"></i>
    </div>
  </div>

  <div class="etablissement-list">
    <div *ngIf="isLoadingEtablissements" class="loading-indicator">
      <div class="spinner"></div>
      <span>Chargement des √©tablissements...</span>
    </div>
    
    <div *ngIf="!isLoadingEtablissements && etablissementsList.length === 0" class="empty-state">
      <i class="bi bi-building-x"></i>
      <p>Aucun √©tablissement trouv√©</p>
      <button class="btn btn-outline-primary" (click)="toggleAddEtablissementForm()">
        <i class="bi bi-plus-circle"></i> Ajouter un √©tablissement
      </button>
    </div>

    <div *ngFor="let etab of filteredEtablissements" class="etablissement-card">
      <div class="etablissement-header" (click)="toggleEtablissement(etab)">
        <div class="etab-info">
          <h3>{{ etab.name }}</h3>
          <span class="etab-details">{{ getEtablissementAddress(etab) }}</span>
        </div>
        <div class="etab-status" [ngClass]="{'active': etab.status === 'active', 'inactive': etab.status === 'inactive', 'suspended': etab.status === 'suspended'}">
          {{ getStatusLabel(etab.status) }}
        </div>
        <i class="bi" [ngClass]="{'bi-chevron-down': etab.expanded, 'bi-chevron-right': !etab.expanded}"></i>
      </div>

<div class="etablissement-actions">
  <button class="btn btn-sm btn-outline-primary" (click)="selectEtablissement(etab)" title="S√©lectionner cet √©tablissement">
    <i class="bi bi-check-circle"></i> S√©lectionner
  </button>
  
  <button class="btn btn-sm btn-outline-secondary" (click)="editEtablissement(etab)" title="Modifier cet √©tablissement">
    <i class="bi bi-pencil"></i> √âditer
  </button>
  
  <button 
    class="btn btn-sm"
    [ngClass]="canDeleteEtablissement(etab) ? 'btn-outline-danger' : 'btn-outline-secondary'"
    [title]="getDeleteEtablissementTooltip(etab)"
    (click)="deleteEtablissement(etab)">
    <i class="bi bi-trash"></i> 
    <span *ngIf="!canDeleteEtablissement(etab)">üîí</span>
    Supprimer
  </button>
</div>
      
      <!-- UF li√©es √† l'√©tablissement -->
      <div *ngIf="etab.expanded" class="uf-container">
        <div *ngIf="isLoadingUFs(etab.id)" class="loading-indicator sm">
          <div class="spinner sm"></div>
          <span>Chargement des UF...</span>
        </div>
        
        <div *ngIf="!isLoadingUFs(etab.id) && getUFsForEtablissement(etab.id).length === 0" class="empty-state sm">
          <p>Aucune unit√© fonctionnelle trouv√©e</p>
          <button class="btn btn-sm btn-outline-primary" (click)="createNewUF(etab)">
            <i class="bi bi-plus-circle"></i> Nouvelle UF
          </button>
        </div>
        
        <div *ngFor="let uf of getUFsForEtablissement(etab.id)" class="uf-card">
          <div class="uf-info">
            <div class="uf-title">
              <h4>{{ uf.name }}</h4>
              <span class="uf-numero">{{ getUFNumero(uf) }}</span>
            </div>
            <span class="uf-location" *ngIf="uf.description || getUFLocation(uf)">
              <i class="bi bi-geo-alt"></i> {{ uf.description || getUFLocation(uf) }}
            </span>
            <div class="uf-status" [ngClass]="{'active': uf.status === 'active', 'inactive': uf.status === 'inactive', 'suspended': uf.status === 'suspended'}">
              {{ getStatusLabel(uf.status) }}
            </div>
                  <div class="etablissement-actions">
<button class="btn btn-sm btn-outline-primary " (click)="editEtablissement(etab)">
          <i class="bi bi-pencil">√©diter</i> 
        </button>
            <button class="btn btn-sm btn-outline-danger " (click)="deleteUF(uf)">
          <i class="bi bi-pencil">supprimer</i> 
        </button>
         
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <div class="panel-footer">
    <button class="btn btn-primary" (click)="toggleAddEtablissementForm()">
      <i class="bi bi-plus-circle"></i> Nouvel √©tablissement
    </button>
    <button class="btn btn-outline-secondary" (click)="refreshList()">
      <i class="bi bi-arrow-clockwise"></i> Actualiser
    </button>
  </div>
</div>