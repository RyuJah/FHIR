<div *ngIf="showPopup" class="popup-notification" [ngClass]="{'popup-success': popupType === 'success', 'popup-error': popupType === 'error'}">
  <div class="popup-content">
    <i [ngClass]="{'bi bi-check-circle-fill': popupType === 'success', 'bi bi-x-circle-fill': popupType === 'error'}"></i>
    <p>{{ popupMessage }}</p>
  </div>
</div>

<div class="page-container">
  <!-- Panneau lat√©ral gauche -->
  <div class="side-panel left-panel">
    <div class="slide-container">
      <!-- Utilisez *ngFor pour cr√©er les slides de mani√®re dynamique -->
      <div *ngFor="let slide of slides" class="slide" [class.active]="slide.active">
        <img [src]="slide.imageUrl" [alt]="slide.title">
        <div class="info-overlay">
          <h3>{{ slide.title }}</h3>
          <p>{{ slide.description }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenu principal (formulaire) -->
  <div class="main-content">
    <h2>Cr√©er une Unit√© Fonctionnelle</h2>
    
    <form [formGroup]="myForm" (ngSubmit)="onSubmit()" class="form">
      <div class="progress-bar">
        <div class="progress" [style.width]="(currentSlide + 1) * (100 / totalSlides) + '%'"></div>
      </div>
      <div class="step-indicator">
        √âtape {{ currentSlide + 1 }} sur {{ totalSlides }}
      </div>
      
      <swiper-container #swiper allowTouchMove="false">
        <!-- Page 1: Informations g√©n√©rales -->
        <swiper-slide>
          <div class="slide-content">
            <h3>Informations g√©n√©rales</h3>
            
            <!-- Nom de l'unit√© fonctionnelle -->
            <div class="form-group">
              <label for="name">Nom de l'unit√© fonctionnelle</label>
              <input 
                type="text" 
                id="name" 
                formControlName="name"
                placeholder="Ex: Service de Cardiologie"
              >
              <div *ngIf="isFieldInvalid('name')" class="error-message">
                {{ getErrorMessage('name') }}
              </div>
            </div>
           
            <!-- UF Num√©rique unique -->
            <div class="form-group">
              <label for="ufNumero">Num√©ro UF (unique)</label>
              <input 
                type="text" 
                id="ufNumero" 
                formControlName="ufNumero"
                placeholder="Ex: 1234"
              >
              <small class="form-text text-muted">Doit √™tre compos√© de 4 √† 6 chiffres et doit √™tre unique.</small>
              <div *ngIf="isFieldInvalid('ufNumero')" class="error-message">
                {{ getErrorMessage('ufNumero') }}
              </div>
            </div>
            
            <!-- Description -->
            <div class="form-group">
              <label for="description">Description</label>
              <textarea
                id="description"
                formControlName="description"
                placeholder="Description de l'unit√© fonctionnelle"
                rows="2"
              ></textarea>
            </div>
            
            <!-- Statut -->
            <div class="form-group">
              <label for="status">Statut</label>
              <select 
                id="status" 
                formControlName="status" 
              >
                <option value="active">Actif</option>
                <option value="suspended">Suspendu</option>
                <option value="inactive">Inactif</option>
              </select>
              <div *ngIf="isFieldInvalid('status')" class="error-message">
                {{ getErrorMessage('status') }}
              </div>
            </div>
            
            <!-- √âtablissement parent -->
            <div class="form-group">
              <label for="etablissementId">√âtablissement parent</label>
              <div class="etablissement-selection">
                <select 
                  id="etablissementId" 
                  formControlName="etablissementId" 
                  [disabled]="isLoading"
                >
                  <option value="" disabled selected>S√©lectionnez un √©tablissement</option>
                  <option *ngFor="let etab of etablissements" [value]="etab.id">
                    {{ etab.name }}
                  </option>
                </select>
                
                <button 
                  type="button" 
                  class="btn btn-secondary" 
                  (click)="toggleAddEtablissementForm()" 
                  [disabled]="isEditingEtablissement"
                >
                  <span *ngIf="showAddEtablissementForm && !isEditingEtablissement">Annuler</span>
                  <span *ngIf="!showAddEtablissementForm || isEditingEtablissement">Nouvel √©tablissement</span>
                </button>
              </div>
              
              <div *ngIf="isLoading" class="loading-message">
                Chargement des √©tablissements...
              </div>
              <div *ngIf="loadingError" class="error-message">
                Erreur lors du chargement des √©tablissements. 
                <button type="button" class="btn btn-link" (click)="loadEtablissements()">
                  R√©essayer
                </button>
              </div>
              <div *ngIf="isFieldInvalid('etablissementId')" class="error-message">
                {{ getErrorMessage('etablissementId') }}
              </div>
            </div>
            
            <!-- Formulaire pour ajouter/modifier un √©tablissement -->
            <div *ngIf="showAddEtablissementForm" class="add-etablissement-form">
              <h4>
                <i class="bi" [ngClass]="{'bi-pencil-square': isEditingEtablissement, 'bi-plus-circle': !isEditingEtablissement}"></i>
                {{ isEditingEtablissement ? 'Modifier l\'√©tablissement' : 'Ajouter un nouvel √©tablissement' }}
              </h4>
              
              <!-- Indicateur du mode √©dition -->
              <div *ngIf="isEditingEtablissement" class="edit-mode-indicator">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i>
                  Vous √™tes en train de modifier un √©tablissement existant.
                </div>
              </div>
              
              <form [formGroup]="etablissementForm" (ngSubmit)="onAddEtablissement()" class="etablissement-form">
                <div class="form-group">
                  <label for="etabName">Nom de l'√©tablissement <span class="required">*</span></label>
                  <input type="text" id="etabName" formControlName="name" required>
                  <div *ngIf="isFieldInvalid('name', etablissementForm)" class="error-message">
                    {{ getErrorMessage('name', etablissementForm) }}
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="etabStatus">Statut</label>
                  <select id="etabStatus" formControlName="status">
                    <option value="active">Actif</option>
                    <option value="suspended">Suspendu</option>
                    <option value="inactive">Inactif</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="etabTypeCode">Type d'√©tablissement</label>
                  <select id="etabTypeCode" formControlName="typeCode">
                    <option value="ho">H√¥pital</option>
                    <option value="ward">Service</option>
                    <option value="dept">D√©partement</option>
                    <option value="room">Salle</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="etabAddressUse">Type d'adresse</label>
                  <select id="etabAddressUse" formControlName="addressUse">
                    <option value="work">Travail</option>
                    <option value="temp">Temporaire</option>
                    <option value="old">Ancienne</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="etabAddressLine">Adresse</label>
                  <input type="text" id="etabAddressLine" formControlName="addressLine" placeholder="Num√©ro et nom de rue">
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="etabCity">Ville <span class="required">*</span></label>
                    <input type="text" id="etabCity" formControlName="city" required>
                    <div *ngIf="isFieldInvalid('city', etablissementForm)" class="error-message">
                      {{ getErrorMessage('city', etablissementForm) }}
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label for="etabPostalCode">Code postal <span class="required">*</span></label>
                    <input type="text" id="etabPostalCode" formControlName="postalCode" required>
                    <div *ngIf="isFieldInvalid('postalCode', etablissementForm)" class="error-message">
                      {{ getErrorMessage('postalCode', etablissementForm) }}
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="etabCountry">Pays</label>
                  <input type="text" id="etabCountry" formControlName="country" value="FR">
                </div>
                
                <div class="form-buttons">
                  <button type="button" class="btn btn-secondary" (click)="toggleAddEtablissementForm()">
                    <i class="bi bi-x-circle"></i>
                    {{ isEditingEtablissement ? 'Annuler la modification' : 'Annuler' }}
                  </button>
                  
                  <button type="submit" class="btn" 
                          [ngClass]="{'btn-warning': isEditingEtablissement, 'btn-primary': !isEditingEtablissement}"
                          [disabled]="etablissementForm.invalid">
                    <i class="bi" [ngClass]="{'bi-check-circle': isEditingEtablissement, 'bi-plus-circle': !isEditingEtablissement}"></i>
                    {{ isEditingEtablissement ? 'Modifier l\'√©tablissement' : 'Cr√©er l\'√©tablissement' }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </swiper-slide>
        
        <!-- Page 2: Informations de localisation dans l'√©tablissement -->
        <swiper-slide>
          <div class="slide-content">
            <h3>Localisation dans l'√©tablissement</h3>
            
            <!-- √âtage -->
            <div class="form-group">
              <label for="floor">√âtage</label>
              <input
                type="text"
                id="floor"
                formControlName="floor"
                placeholder="Ex: 2, Rez-de-chauss√©e, etc."
              >
            </div>
            
            <!-- Aile/B√¢timent -->
            <div class="form-group">
              <label for="wing">Aile/B√¢timent</label>
              <input
                type="text"
                id="wing"
                formControlName="wing"
                placeholder="Ex: Aile Est, Pavillon B, etc."
              >
            </div>
            
            <!-- Num√©ro de salle -->
            <div class="form-group">
              <label for="roomNumber">Num√©ro de salle</label>
              <input
                type="text"
                id="roomNumber"
                formControlName="roomNumber"
                placeholder="Ex: 204, A12, etc."
              >
            </div>
            
            <!-- Adresse - Utilisation -->
            <div class="form-group">
              <label for="addressUse">Type d'adresse</label>
              <select 
                id="addressUse" 
                formControlName="addressUse" 
              >
                <option value="work">Travail</option>
                <option value="temp">Temporaire</option>
                <option value="old">Ancienne</option>
              </select>
              <div *ngIf="isFieldInvalid('addressUse')" class="error-message">
                {{ getErrorMessage('addressUse') }}
              </div>
            </div>
          </div>
        </swiper-slide>
        
        <!-- Page 3: R√©capitulatif et soumission -->
        <swiper-slide>
          <div class="slide-content summary">
            <h3>R√©capitulatif</h3>
            
            <div class="summary-section">
              <h4>Informations g√©n√©rales</h4>
              <div class="summary-item">
                <span class="label">Nom de l'UF:</span> 
                <span class="value">{{ myForm.get('name')?.value }}</span>
              </div>
              <div class="summary-item">
                <span class="label">ZADIG:</span> 
                <span class="value">{{ myForm.get('ufNumero')?.value }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Description:</span> 
                <span class="value">{{ myForm.get('description')?.value || 'Non sp√©cifi√©e' }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Statut:</span> 
                <span class="value">{{ getStatusLabel(myForm.get('status')?.value) }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Type:</span> 
                <span class="value">{{ getTypeLabel(myForm.get('typeCode')?.value) }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">√âtablissement parent:</span> 
                <span class="value">{{ getEtablissementName(myForm.get('etablissementId')?.value) }}</span>
              </div>
            </div>
            
            <div class="summary-section">
              <h4>Localisation dans l'√©tablissement</h4>
              <div class="summary-item">
                <span class="label">√âtage:</span> 
                <span class="value">{{ myForm.get('floor')?.value || 'Non sp√©cifi√©' }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Aile/B√¢timent:</span> 
                <span class="value">{{ myForm.get('wing')?.value || 'Non sp√©cifi√©' }}</span>
              </div>
              
              <div class="summary-item">
                <span class="label">Num√©ro de salle:</span> 
                <span class="value">{{ myForm.get('roomNumber')?.value || 'Non sp√©cifi√©' }}</span>
              </div>
            </div>
          </div>
        </swiper-slide>
      </swiper-container>
      
      <div class="form-navigation">
        <!-- Bouton Pr√©c√©dent uniquement si currentSlide > 0 -->
        <button *ngIf="currentSlide > 0" type="button" class="btn btn-primary" (click)="previousSlide()">
          Pr√©c√©dent
        </button>
        <div *ngIf="currentSlide === 0"></div>
        
        <button *ngIf="currentSlide < totalSlides - 1" type="button" class="btn btn-primary" (click)="nextSlide()">
          Suivant
        </button>
        
        <button *ngIf="currentSlide === totalSlides - 1" type="submit" class="btn btn-success" [disabled]="!myForm.valid">
          Cr√©er l'unit√© fonctionnelle
        </button>
      </div>
    </form>
  </div>

  <!-- Panneau lat√©ral droit : Liste des √©tablissements et UF -->
  <div class="side-panel right-panel">
    <div class="panel-header">
      <h2>√âtablissements et Unit√©s Fonctionnelles</h2>
      <div class="search-container">
        <input type="text" placeholder="Rechercher..." [(ngModel)]="searchTerm" (input)="filterList()">
        <i class="bi bi-search search-icon"></i>
      </div>
    </div>

    <div class="etablissement-list">
      <div *ngIf="isLoadingEtablissements" class="loading-indicator">
        <div class="spinner"></div>
        <span>Chargement des √©tablissements...</span>
      </div>
      
      <div *ngIf="!isLoadingEtablissements && etablissementsList.length === 0" class="empty-state">
        <i class="bi bi-building-x"></i>
        <p>Aucun √©tablissement trouv√©</p>
        <button class="btn btn-outline-primary" (click)="toggleAddEtablissementForm()">
          <i class="bi bi-plus-circle"></i> Ajouter un √©tablissement
        </button>
      </div>

      <div *ngFor="let etab of filteredEtablissements" class="etablissement-card">
        <div class="etablissement-header" (click)="toggleEtablissement(etab)">
          <div class="etab-info">
            <h3>{{ etab.name }}</h3>
            <span class="etab-details">{{ getEtablissementAddress(etab) }}</span>
          </div>
          <div class="etab-status" [ngClass]="{'active': etab.status === 'active', 'inactive': etab.status === 'inactive', 'suspended': etab.status === 'suspended'}">
            {{ getStatusLabel(etab.status) }}
          </div>
          <i class="bi" [ngClass]="{'bi-chevron-down': etab.expanded, 'bi-chevron-right': !etab.expanded}"></i>
        </div>

        <div class="etablissement-actions">
          <button class="btn btn-sm btn-outline-primary" (click)="selectEtablissement(etab)" title="S√©lectionner cet √©tablissement">
            <i class="bi bi-check-circle"></i> S√©lectionner
          </button>
          
          <button class="btn btn-sm btn-outline-secondary" (click)="editEtablissement(etab)" title="Modifier cet √©tablissement">
            <i class="bi bi-pencil"></i> √âditer
          </button>
          
          <button 
            class="btn btn-sm"
            [ngClass]="canDeleteEtablissement(etab) ? 'btn-outline-danger' : 'btn-outline-secondary'"
            [title]="getDeleteEtablissementTooltip(etab)"
            (click)="deleteEtablissement(etab)">
            <i class="bi bi-trash"></i> 
            <span *ngIf="!canDeleteEtablissement(etab)">üîí</span>
            Supprimer
          </button>
        </div>
        
        <!-- UF li√©es √† l'√©tablissement -->
        <div *ngIf="etab.expanded" class="uf-container">
          <div *ngIf="isLoadingUFs(etab.id)" class="loading-indicator sm">
            <div class="spinner sm"></div>
            <span>Chargement des UF...</span>
          </div>
          
          <div *ngIf="!isLoadingUFs(etab.id) && getUFsForEtablissement(etab.id).length === 0" class="empty-state sm">
            <p>Aucune unit√© fonctionnelle trouv√©e</p>
            <button class="btn btn-sm btn-outline-primary" (click)="createNewUF(etab)">
              <i class="bi bi-plus-circle"></i> Nouvelle UF
            </button>
          </div>
          
          <div *ngFor="let uf of getUFsForEtablissement(etab.id)" class="uf-card">
            <div class="uf-info">
              <div class="uf-title">
                <h4>{{ uf.name }}</h4>
                <span class="uf-numero">{{ getUFNumero(uf) }}</span>
              </div>
              <span class="uf-location" *ngIf="uf.description || getUFLocation(uf)">
                <i class="bi bi-geo-alt"></i> {{ uf.description || getUFLocation(uf) }}
              </span>
              <div class="uf-status" [ngClass]="{'active': uf.status === 'active', 'inactive': uf.status === 'inactive', 'suspended': uf.status === 'suspended'}">
                {{ getStatusLabel(uf.status) }}
              </div>
              
              <div class="uf-actions">
                <button class="btn btn-sm btn-outline-primary" (click)="editUF(uf)" title="Modifier cette UF">
                  <i class="bi bi-pencil"></i> √âditer
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteUF(uf)" title="Supprimer cette UF">
                  <i class="bi bi-trash"></i> Supprimer
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel-footer">
      <button class="btn btn-primary" (click)="toggleAddEtablissementForm()">
        <i class="bi bi-plus-circle"></i> Nouvel √©tablissement
      </button>
      <button class="btn btn-outline-secondary" (click)="refreshList()">
        <i class="bi bi-arrow-clockwise"></i> Actualiser
      </button>
    </div>
  </div>
</div>

<!-- Modal d'√©dition UF -->
<div *ngIf="showEditUFModal" class="modal modal-uf-edit fade show" id="editUFModal" 
     style="display: block;" tabindex="-1" aria-labelledby="editUFModalLabel" 
     [style.background-color]="'rgba(0,0,0,0.5)'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUFModalLabel">
          <i class="bi bi-pencil-square"></i>
          Modifier l'Unit√© Fonctionnelle
        </h5>
        <button type="button" class="btn-close" (click)="closeEditUFModal()" aria-label="Fermer"></button>
      </div>
      
      <div class="modal-body">
        <form [formGroup]="editUFForm" (ngSubmit)="onSaveEditUF()">
          <!-- Section Informations g√©n√©rales -->
          <div class="form-section">
            <h4>
              <i class="bi bi-info-circle"></i>
              Informations g√©n√©rales
            </h4>
            
            <div class="form-group">
              <label for="editUfName">Nom de l'unit√© fonctionnelle <span class="required">*</span></label>
              <input 
                type="text" 
                id="editUfName" 
                formControlName="name" 
                placeholder="Ex: Service de Cardiologie"
                [class.is-invalid]="isEditUFFieldInvalid('name')"
              >
              <div *ngIf="isEditUFFieldInvalid('name')" class="error-message">
                {{ getEditUFErrorMessage('name') }}
              </div>
            </div>

            <div class="form-row">
              <!-- <div class="form-group">
                <label for="editUfNumero">Num√©ro UF (unique) <span class="required">*</span></label>
                <input 
                  type="text" 
                  id="editUfNumero" 
                  formControlName="ufNumero" 
                  placeholder="Ex: 1234"
                  [class.is-invalid]="isEditUFFieldInvalid('ufNumero')"
                >
                <small class="form-text">Doit √™tre compos√© de 4 √† 6 chiffres et doit √™tre unique.</small>
                <div *ngIf="isEditUFFieldInvalid('ufNumero')" class="error-message">
                  {{ getEditUFErrorMessage('ufNumero') }}
                </div>
              </div> -->
              
              <div class="form-group">
                <label for="editUfStatus">Statut <span class="required">*</span></label>
                <select 
                  id="editUfStatus" 
                  formControlName="status"
                  [class.is-invalid]="isEditUFFieldInvalid('status')"
                >
                  <option value="active">Actif</option>
                  <option value="suspended">Suspendu</option>
                  <option value="inactive">Inactif</option>
                </select>
                <div *ngIf="isEditUFFieldInvalid('status')" class="error-message">
                  {{ getEditUFErrorMessage('status') }}
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="editUfDescription">Description</label>
              <textarea 
                id="editUfDescription" 
                formControlName="description" 
                placeholder="Description de l'unit√© fonctionnelle"
                rows="3"
              ></textarea>
            </div>

            <div class="form-group">
              <label for="editUfEtablissement">√âtablissement parent <span class="required">*</span></label>
              <select 
                id="editUfEtablissement" 
                formControlName="etablissementId"
                [class.is-invalid]="isEditUFFieldInvalid('etablissementId')"
              >
                <option value="" disabled>S√©lectionnez un √©tablissement</option>
                <option *ngFor="let etab of etablissements" [value]="etab.id">
                  {{ etab.name }}
                </option>
              </select>
              <div *ngIf="isEditUFFieldInvalid('etablissementId')" class="error-message">
                {{ getEditUFErrorMessage('etablissementId') }}
              </div>
            </div>
          </div>

          <!-- Section Localisation -->
          <div class="form-section">
            <h4>
              <i class="bi bi-geo-alt"></i>
              Localisation dans l'√©tablissement
            </h4>
            
            <div class="form-row">
              <div class="form-group">
                <label for="editUfFloor">√âtage</label>
                <input 
                  type="text" 
                  id="editUfFloor" 
                  formControlName="floor" 
                  placeholder="Ex: 2, Rez-de-chauss√©e"
                >
              </div>
              
              <div class="form-group">
                <label for="editUfWing">Aile/B√¢timent</label>
                <input 
                  type="text" 
                  id="editUfWing" 
                  formControlName="wing" 
                  placeholder="Ex: Aile Est, Pavillon B"
                >
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="editUfRoomNumber">Num√©ro de salle</label>
                <input 
                  type="text" 
                  id="editUfRoomNumber" 
                  formControlName="roomNumber" 
                  placeholder="Ex: 204, A12"
                >
              </div>
              
              <div class="form-group">
                <label for="editUfAddressUse">Type d'adresse</label>
                <select 
                  id="editUfAddressUse" 
                  formControlName="addressUse"
                >
                  <option value="work">Travail</option>
                  <option value="temp">Temporaire</option>
                  <option value="old">Ancienne</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Boutons d'action -->
          <div class="btn-group-custom">
            <button type="button" class="btn btn-secondary" (click)="closeEditUFModal()">
              <i class="bi bi-x-circle"></i>
              Annuler
            </button>
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="!canSaveUF()"
            >
              <i class="bi bi-check-circle"></i>
              Enregistrer les modifications
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>